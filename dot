#!/bin/bash

options="install diff status"
vim='.vim'
vimplugin='.config/vim/plugged'
list=(
    '.config'
    '.local'
    '.tmux.conf'
)

printUsage()
{
    echo "Usage: dot [OPTION]"
    echo "OPTIONS:"
    echo "  install"
    echo "  diff"
    echo "  status"
}

judgeRepStatus()
{
    path=$PWD

    cd $1 && rep_branch=`git rev-parse HEAD`
    cd $2 && cur_branch=`git rev-parse HEAD`

    cd $path && [ $rep_branch == $cur_branch ] && return 1

    return 0
}

dotStatus()
{
    flag=0
    dotpath=$PWD

    # Basic Configuration File
    for dir in ${list[@]}; do
        files=`find $dir -type f | grep -v "vim"`

        for file in $files; do
            [ ! -f "$HOME/$file" ] && echo "$file not exit" && continue
            res="`diff $file $HOME/$file`"

            if [ "$res" ]; then
                [ $flag == 0 ] && flag=1 && echo "Changes for dotfiles:"
                echo -e "\e[1;31m    modified:   $file\e[0;37m"
            fi
        done
    done

    # Vim Configuration File
    judgeRepStatus $vim $HOME/$vim
    if [ $? == 0 ]; then
        [ $flag == 0 ] && flag=1 && echo "Changes for dotfiles:"
        echo -e "\e[1;31m    modified:   $vim\e[0;37m"
    fi

    # Vim Plugin Configuration File
    for dir in $vimplugin/*; do
        judgeRepStatus $dir $HOME/$dir
        if [ $? == 0 ]; then
            [ $flag == 0 ] && flag=1 && echo "Changes for dotfiles:"
            echo -e "\e[1;31m    modified:   $dir\e[0;37m"
        fi
    done

    # Untracked Configuration File
    track=0
    cd $HOME
    for dir in ${list[0]}/*; do
        if [ ! -d $dotpath/$dir ]; then
            [ $track == 0 ] && track=1 && echo && echo "Untracked configuration:"
            echo -e "\e[1;31m    $dir\e[0;37m"
        fi
    done

    [ $flag == 0 -a $track == 0 ] && echo "all same"
}

if [ $# -ne 1 ]; then
    printUsage
    exit 1
fi

case $1 in
    status)
        dotStatus
        ;;
    diff)
        ;;
    install)
        ;;
    *)
        echo "error: wrong option" && echo
        printUsage
        exit 2
        ;;
esac
