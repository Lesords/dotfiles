#!/bin/bash

options="install diff status"
vim='.vim'
vimplugin='.config/vim/plugged'
list=(
    '.config'
    '.local'
    '.tmux.conf'
)

printUsage()
{
    echo "Usage: dot [OPTION]"
    echo "OPTIONS:"
    echo "  install"
    echo "  diff"
    echo "  status"
}

judgeRepStatus()
{
    path=$PWD

    cd $1 && rep_branch=`git rev-parse HEAD`
    cd $2 && cur_branch=`git rev-parse HEAD`

    cd $path && [ $rep_branch == $cur_branch ] && return 1

    return 0
}

dotStatus()
{
    flag=0
    dotpath=$PWD

    # Basic Configuration File
    for dir in ${list[@]}; do
        files=`find $dir -type f | grep -v "vim"`

        for file in $files; do
            [ ! -f "$HOME/$file" ] && echo "$file not exist" && continue
            res="`diff $file $HOME/$file`"

            if [ "$res" ]; then
                [ $flag == 0 ] && flag=1 && echo "Changes for dotfiles:"
                echo -e "\e[1;31m    modified:   $file\e[0;37m"
            fi
        done
    done

    # Vim Configuration File
    judgeRepStatus $vim $HOME/$vim
    if [ $? == 0 ]; then
        [ $flag == 0 ] && flag=1 && echo "Changes for dotfiles:"
        echo -e "\e[1;31m    modified:   $vim\e[0;37m"
    fi

    # Vim Plugin Configuration File
    for dir in $vimplugin/*; do
        judgeRepStatus $dir $HOME/$dir
        if [ $? == 0 ]; then
            [ $flag == 0 ] && flag=1 && echo "Changes for dotfiles:"
            echo -e "\e[1;31m    modified:   $dir\e[0;37m"
        fi
    done

    # Untracked Configuration File
    track=0
    cd $HOME
    for dir in ${list[0]}/*; do
        if [ ! -d $dotpath/$dir ]; then
            [ $track == 0 ] && track=1 && echo && echo "Untracked configuration:"
            echo -e "\e[1;31m    $dir\e[0;37m"
        fi
    done

    [ $flag == 0 -a $track == 0 ] && echo "all same"
}

diffRep()
{
    path=$PWD

    cd $1 && rep_branch=`git rev-parse HEAD | cut -c-12`
    cd $2 && cur_branch=`git rev-parse HEAD | cut -c-12`

    cd $path && [ $rep_branch == $cur_branch ] && return 1

    echo && echo -e "\e[38;5;11m$1 \e[38;5;11m-> \e[7m$HOME/\e[27m$1\e[0m"
    echo -e "\e[1;31m$rep_branch\e[0m..\e[1;32m$cur_branch\e[0m"
    return 0
}

diffFile()
{
    res="`diff $1 $2`"

    if [ "$res" ]; then
        if type diff-so-fancy >/dev/null 2>&1; then
            echo && (diff -ru $1 $2 | diff-so-fancy)
        else
            diff -ru $1 $2
        fi
    fi
}

dotDiff()
{
    # Basic Configuration File
    for dir in ${list[@]}; do
        files=`find $dir -type f | grep -v "vim"`

        for file in $files; do
            [ ! -f "$HOME/$file" ] && echo "$file not exist" && continue
            diffFile $file $HOME/$file
        done
    done

    # Vim Configuration File
    files=`find $vim -type f | grep -v "\.git"`
    for file in $files; do
        [ ! -f "$HOME/$file" ] && echo "$file not exist"
        diffFile $file $HOME/$file
    done

    # Vim Plugin Configuration File
    for dir in $vimplugin/*; do
        diffRep $dir $HOME/$dir
    done
}

if [ $# -ne 1 ]; then
    printUsage
    exit 1
fi

case $1 in
    status)
        dotStatus
        ;;
    diff)
        dotDiff
        ;;
    install)
        ;;
    *)
        echo "error: wrong option" && echo
        printUsage
        exit 2
        ;;
esac
